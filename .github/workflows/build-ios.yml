name: Build iOS App

on:
  push:
    branches: [main]
    paths:
      - 'apps/ios/**'
      - '.github/workflows/build-ios.yml'
  pull_request:
    branches: [main]
    paths:
      - 'apps/ios/**'
  workflow_dispatch:

env:
  SCHEME: OFFLEASH
  PROJECT: OFFLEASH.xcodeproj
  BUNDLE_ID: com.offleash.ios

jobs:
  changes:
    name: Detect Auth Changes
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
    steps:
      - uses: actions/checkout@v4
      - name: Filter Paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            auth:
              - 'apps/api/**'
              - 'apps/api/config/**'
              - 'apps/api/routes/auth/**'
              - 'apps/api/services/auth/**'
              - 'crates/auth/**'
              - 'migrations/**'

  # Build and test on PRs only (no signing required)
  build:
    name: Build & Test
    runs-on: macos-14  # M1 runner - significantly faster than Intel
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    defaults:
      run:
        working-directory: apps/ios

    steps:
      - uses: actions/checkout@v4

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: |
            apps/ios/build/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('apps/ios/**/*.swift', 'apps/ios/**/*.xcodeproj/**') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('apps/ios/OFFLEASH.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | tail -1)
          echo "Using Xcode at: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version

      - name: Build for testing
        id: build
        run: |
          BUILD_START=$(date +%s)

          # Find the first available iPhone simulator
          SIMULATOR_NAME=$(xcrun simctl list devices available | grep -m 1 "iPhone" | sed -E 's/^[[:space:]]+([^(]+).*/\1/' | xargs)
          echo "Using simulator: $SIMULATOR_NAME"

          # Build with parallel targets and maximum jobs
          xcodebuild build \
            -project $PROJECT \
            -scheme $SCHEME \
            -destination "platform=iOS Simulator,name=$SIMULATOR_NAME" \
            -configuration Debug \
            -derivedDataPath ./build/DerivedData \
            -parallelizeTargets \
            -jobs $(sysctl -n hw.ncpu) \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee build.log

          APP_PATH=$(find ./build/DerivedData -name "*.app" -type d | head -1)
          echo "app-path=$APP_PATH" >> $GITHUB_OUTPUT

          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          echo "build_duration=${BUILD_DURATION}" >> $GITHUB_OUTPUT
          echo "::notice::Build completed in ${BUILD_DURATION}s"

      - name: Upload App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: apps/ios/${{ steps.build.outputs.app-path }}
          retention-days: 1

  appium-tests:
    name: Appium Tests
    needs: [build, changes]
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - auth
          - customer-booking
          - customer-profile
          - walker-core
          - walker-settings
          - error-handling
          - multi-tenant
    steps:
      - uses: actions/checkout@v4

      - name: Download App
        uses: actions/download-artifact@v4
        with:
          name: ios-app
          path: apps/ios/build

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/ios/appium-tests/package-lock.json

      - name: Install Dependencies
        working-directory: apps/ios/appium-tests
        run: npm ci

      - name: Install Appium
        run: |
          npm install -g appium
          appium driver install xcuitest

      - name: Boot Simulator
        run: |
          SIMULATOR_NAME=$(xcrun simctl list devices available | grep -m 1 "iPhone" | sed -E 's/^[[:space:]]+([^(]+).*/\\1/' | xargs)
          echo "Using simulator: $SIMULATOR_NAME"
          xcrun simctl boot "$SIMULATOR_NAME" || true
          xcrun simctl bootstatus "$SIMULATOR_NAME" -b

      - name: Coverage Gate
        working-directory: apps/ios/appium-tests
        run: npm run coverage:check

      - name: Run Appium Tests
        working-directory: apps/ios/appium-tests
        run: |
          APP_PATH=$(find ${{ github.workspace }}/apps/ios/build -name "*.app" -type d | head -1)
          AUTH_MODE="mock"
          if [[ "${{ matrix.test-suite }}" == "auth" && "${{ needs.changes.outputs.auth }}" == "true" ]]; then
            AUTH_MODE="real"
          fi
          echo "Using auth mode: $AUTH_MODE"
          OFFLEASH_TEST_AUTH="$AUTH_MODE" IOS_APP_PATH="$APP_PATH" npm run test:${{ matrix.test-suite }}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            apps/ios/appium-tests/allure-results
            apps/ios/appium-tests/screenshots
          retention-days: 7

  # Deploy to TestFlight on main branch pushes (runs in parallel, no wait)
  deploy-testflight:
    name: Deploy to TestFlight
    runs-on: macos-14  # M1 runner - significantly faster than Intel
    needs: [appium-tests]
    if: ((github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch') && needs.appium-tests.result == 'success'
    defaults:
      run:
        working-directory: apps/ios

    steps:
      - uses: actions/checkout@v4

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: |
            apps/ios/build/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('apps/ios/**/*.swift', 'apps/ios/**/*.xcodeproj/**') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: Cache SPM packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('apps/ios/OFFLEASH.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app | tail -1)
          echo "Using Xcode at: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH"
          xcodebuild -version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: apps/ios

      - name: Create App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p fastlane
          echo -n "$API_KEY_BASE64" | base64 --decode > fastlane/AuthKey.p8
          chmod 600 fastlane/AuthKey.p8

      - name: Install signing certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          security find-identity -v -p codesigning $KEYCHAIN_PATH

      - name: Install provisioning profile
        id: install-profile
        env:
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # Extract both UUID and Name from the profile
          PP_CONTENT=$(/usr/bin/security cms -D -i $PP_PATH)
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< "$PP_CONTENT")
          PP_NAME=$(/usr/libexec/PlistBuddy -c "Print Name" /dev/stdin <<< "$PP_CONTENT")

          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$PP_UUID.mobileprovision

          echo "Installed provisioning profile: $PP_NAME (UUID: $PP_UUID)"
          echo "PP_UUID=$PP_UUID" >> $GITHUB_OUTPUT
          echo "PP_NAME=$PP_NAME" >> $GITHUB_OUTPUT

      - name: Deploy to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY_FILEPATH: ./fastlane/AuthKey.p8
          APPLE_PROVISIONING_PROFILE_NAME: ${{ steps.install-profile.outputs.PP_NAME }}
          APPLE_PROVISIONING_PROFILE_UUID: ${{ steps.install-profile.outputs.PP_UUID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 5
        run: |
          bundle exec fastlane beta_manual \
            changelog:"${{ github.event.head_commit.message }}"

      - name: Clean up
        if: always()
        run: |
          rm -f fastlane/AuthKey.p8 || true
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/* || true
