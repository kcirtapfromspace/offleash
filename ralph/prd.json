{
  "project": "OFFLEASH",
  "branchName": "ralph/ios-auth-reliability-observability",
  "description": "iOS App Authentication, Reliability & Observability - Fix auth recovery flow, add caching, implement observability, and security hardening",
  "userStories": [
    {
      "id": "US-061",
      "title": "Create AuthState publisher in APIClient",
      "description": "As a developer, I need APIClient to publish auth state changes so the app can react to session expiry.",
      "acceptanceCriteria": [
        "Add NotificationCenter notification name: Notification.Name.authStateChanged",
        "Post notification with userInfo containing 'isAuthenticated' boolean when token is set or cleared",
        "Post notification from setAuthToken() and clearAuthToken() methods",
        "Post notification with isAuthenticated=false when 401 response received",
        "Typecheck passes (swift build)"
      ],
      "priority": 61,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-062",
      "title": "Add session expiry alert UI",
      "description": "As a customer, I need to see a message when my session expires so I understand why I'm being logged out.",
      "acceptanceCriteria": [
        "Create SessionExpiredAlert view modifier in Utilities/SessionExpiredAlert.swift",
        "Show alert with title 'Session Expired' and message 'Please log in again'",
        "Alert has single 'OK' button that dismisses",
        "Alert triggers navigation to login (via callback)",
        "Typecheck passes (swift build)"
      ],
      "priority": 62,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-063",
      "title": "Implement session recovery in OFFLEASHApp",
      "description": "As a customer, when my session expires I should be automatically redirected to login.",
      "acceptanceCriteria": [
        "OFFLEASHApp observes Notification.Name.authStateChanged",
        "When isAuthenticated becomes false, set local isAuthenticated state to false",
        "Show SessionExpiredAlert before navigating to login",
        "Clear any in-progress booking state when session expires",
        "Typecheck passes (swift build)",
        "Verify in simulator: force 401 response, confirm alert shows and redirects to login"
      ],
      "priority": 63,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-064",
      "title": "Create token validation response model",
      "description": "As a developer, I need models for the token validation endpoint response.",
      "acceptanceCriteria": [
        "Create TokenValidationResponse struct in Models/TokenValidation.swift",
        "Fields: valid (Bool), expiresAt (Date?)",
        "Struct conforms to Decodable",
        "Typecheck passes (swift build)"
      ],
      "priority": 64,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-065",
      "title": "Add validateToken method to APIClient",
      "description": "As a developer, I need an API method to validate the stored token.",
      "acceptanceCriteria": [
        "Add validateToken() async throws -> TokenValidationResponse method to APIClient",
        "Calls GET /auth/validate endpoint",
        "Returns TokenValidationResponse on success",
        "Throws APIError.unauthorized on 401",
        "Typecheck passes (swift build)"
      ],
      "priority": 65,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-066",
      "title": "Implement token validation on app launch",
      "description": "As a customer, when I open the app with a stored token, it should verify the token is still valid.",
      "acceptanceCriteria": [
        "Add AppState enum: .launching, .validating, .authenticated, .unauthenticated",
        "On app launch, if token exists, set state to .validating and call validateToken()",
        "Show ProgressView with 'Verifying session...' during validation",
        "If valid: set state to .authenticated, show ContentView",
        "If invalid/401: clear token, set state to .unauthenticated, show LoginView",
        "If network error: set state to .authenticated (graceful degradation), show ContentView",
        "Typecheck passes (swift build)",
        "Verify in simulator: test with valid token, expired token, and airplane mode"
      ],
      "priority": 66,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-067",
      "title": "Create CacheManager actor",
      "description": "As a developer, I need a reusable caching layer that persists data to disk with TTL support.",
      "acceptanceCriteria": [
        "Create Services/CacheManager.swift as an actor",
        "Generic support for any Codable type",
        "Methods: get<T>(key:) -> T?, set<T>(key:value:ttl:), remove(key:), clear()",
        "Persist to FileManager.default.urls(for: .cachesDirectory)",
        "Store metadata (expiry timestamp) alongside cached data",
        "Return nil from get() if TTL expired",
        "Typecheck passes (swift build)"
      ],
      "priority": 67,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-068",
      "title": "Add cache size limit with LRU eviction",
      "description": "As a developer, I need the cache to enforce a size limit to prevent disk bloat.",
      "acceptanceCriteria": [
        "Add maxCacheSize property (default 50MB) to CacheManager",
        "Track cache entry sizes and access times",
        "On set(), if total size exceeds limit, evict least recently used entries",
        "Add currentCacheSize() method for debugging",
        "Typecheck passes (swift build)"
      ],
      "priority": 68,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-069",
      "title": "Cache services list with stale-while-revalidate",
      "description": "As a customer, I want to see the services list instantly on repeat visits.",
      "acceptanceCriteria": [
        "ServicesView checks CacheManager for 'services' key before network request",
        "If cache hit: show cached data immediately, then fetch fresh data in background",
        "If cache miss: show loading state, fetch from network, cache response with 5-minute TTL",
        "Update UI when background refresh completes (if data changed)",
        "Pull-to-refresh bypasses cache and forces network fetch",
        "Typecheck passes (swift build)",
        "Verify in simulator: load services, kill app, relaunch, confirm instant display"
      ],
      "priority": 69,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-070",
      "title": "Cache locations list with invalidation",
      "description": "As a customer, I want to see my saved locations instantly.",
      "acceptanceCriteria": [
        "LocationSelectionView checks CacheManager for 'locations' key before network request",
        "Same stale-while-revalidate pattern as services",
        "Cache TTL: 10 minutes",
        "Add CacheManager.invalidate(key:) method",
        "Invalidate 'locations' cache when customer adds/edits/deletes a location",
        "Typecheck passes (swift build)",
        "Verify in simulator: load locations, kill app, relaunch, confirm instant display"
      ],
      "priority": 70,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-071",
      "title": "Update services fetch to use server-side filtering",
      "description": "As a developer, I want to filter inactive services on the server to reduce payload size.",
      "acceptanceCriteria": [
        "Update ServicesView fetchServices() to call GET /services?active=true",
        "Add queryItems parameter support to APIClient.get() method",
        "Remove client-side .filter { $0.isActive } from ServicesView",
        "Typecheck passes (swift build)"
      ],
      "priority": 71,
      "passes": false,
      "notes": "Assumes backend supports ?active=true query param"
    },
    {
      "id": "US-072",
      "title": "Create AnalyticsService protocol and stub",
      "description": "As a developer, I need an analytics abstraction for testability.",
      "acceptanceCriteria": [
        "Create Services/AnalyticsService.swift with AnalyticsService protocol",
        "Protocol methods: trackScreenView(screenName:), trackEvent(name:params:), trackError(error:context:)",
        "Create StubAnalyticsService that logs to console (for development)",
        "Inject via environment or singleton pattern",
        "Typecheck passes (swift build)"
      ],
      "priority": 72,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-073",
      "title": "Integrate Firebase Analytics SDK",
      "description": "As a product manager, I need analytics infrastructure to measure customer behavior.",
      "acceptanceCriteria": [
        "Add Firebase SDK dependency via Swift Package Manager",
        "Create FirebaseAnalyticsService implementing AnalyticsService protocol",
        "Configure Firebase in OFFLEASHApp.init() with FirebaseApp.configure()",
        "Create GoogleService-Info.plist placeholder with instructions",
        "Typecheck passes (swift build)"
      ],
      "priority": 73,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-074",
      "title": "Track screen view events",
      "description": "As a product manager, I want to know which screens customers visit.",
      "acceptanceCriteria": [
        "Add .onAppear { analyticsService.trackScreenView(screenName:) } to: LoginView, RegisterView, ServicesView, LocationSelectionView, BookingStartView",
        "Screen names: 'login', 'register', 'services', 'location_selection', 'booking_start'",
        "Typecheck passes (swift build)"
      ],
      "priority": 74,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-075",
      "title": "Track time-to-interactive metrics",
      "description": "As an engineer, I want to measure how long customers wait for content to load.",
      "acceptanceCriteria": [
        "Add startTime property to ServicesView and LocationSelectionView",
        "Record Date() in .onAppear",
        "When isLoading becomes false, calculate duration and call analyticsService.trackEvent('tti', params: ['screen': screenName, 'duration_ms': duration, 'cache_hit': wasCacheHit])",
        "Typecheck passes (swift build)"
      ],
      "priority": 75,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-076",
      "title": "Track API error events",
      "description": "As an engineer, I want to know when and where customers encounter errors.",
      "acceptanceCriteria": [
        "Update APIClient request() method to call analyticsService.trackError() on any error",
        "Include context: endpoint path, HTTP method, status code (if available), error type",
        "Redact any auth tokens from logged data",
        "Typecheck passes (swift build)"
      ],
      "priority": 76,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-077",
      "title": "Track booking funnel progression",
      "description": "As a product manager, I want to measure conversion through the booking funnel.",
      "acceptanceCriteria": [
        "Track 'funnel_step' event with step parameter at each stage",
        "Steps: 'services_viewed', 'service_selected', 'location_selected', 'booking_started', 'booking_confirmed'",
        "Include service_id and location_id where applicable",
        "Typecheck passes (swift build)"
      ],
      "priority": 77,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-078",
      "title": "Integrate Firebase Crashlytics",
      "description": "As an engineer, I want to be notified of app crashes with stack traces.",
      "acceptanceCriteria": [
        "Add FirebaseCrashlytics dependency via Swift Package Manager",
        "Configure Crashlytics in OFFLEASHApp.init()",
        "Set user ID for authenticated users: Crashlytics.crashlytics().setUserID()",
        "Clear user ID on logout",
        "Typecheck passes (swift build)"
      ],
      "priority": 78,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-079",
      "title": "Implement certificate pinning",
      "description": "As a security engineer, I want to prevent MITM attacks on API communication.",
      "acceptanceCriteria": [
        "Create URLSessionDelegate in APIClient that implements urlSession(_:didReceive:completionHandler:)",
        "Extract server certificate from SecTrust",
        "Compare certificate public key hash against pinned hashes",
        "Store pinned hashes in array (primary + backup for rotation)",
        "Reject connection if no pin matches",
        "Add documentation comment explaining certificate rotation procedure",
        "Typecheck passes (swift build)"
      ],
      "priority": 79,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-080",
      "title": "Strengthen email validation",
      "description": "As a customer, I want clear feedback if my email format is invalid.",
      "acceptanceCriteria": [
        "Create Utilities/Validators.swift with isValidEmail(_:) function",
        "Use proper email regex (at minimum: contains @, has domain with dot)",
        "Add @State emailError: String? to LoginView and RegisterView",
        "Validate on field blur (onChange with debounce) and on submit",
        "Show red error text below email field when invalid",
        "Error message: 'Please enter a valid email address'",
        "Typecheck passes (swift build)",
        "Verify in simulator: test with invalid emails"
      ],
      "priority": 80,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-081",
      "title": "Add password strength requirements UI",
      "description": "As a customer, I want to understand password requirements during registration.",
      "acceptanceCriteria": [
        "Create Components/PasswordRequirements.swift view",
        "Display requirements: min 8 chars, 1 uppercase, 1 number",
        "Show checkmark (SF Symbol: checkmark.circle.fill, green) for met requirements",
        "Show empty circle (SF Symbol: circle, gray) for unmet requirements",
        "Add PasswordRequirements view below password field in RegisterView",
        "Update isRegisterEnabled to check all requirements met",
        "Typecheck passes (swift build)",
        "Verify in simulator: requirements update in real-time"
      ],
      "priority": 81,
      "passes": false,
      "notes": ""
    }
  ]
}
