{
  "branchName": "ralph/ios-auth-reliability-observability",
  "description": "iOS App Authentication, Reliability & Observability - Fix auth recovery flow, add caching, implement observability, and security hardening",
  "project": "OFFLEASH",
  "userStories": [
    {
      "acceptanceCriteria": [
        "Add NotificationCenter notification name: Notification.Name.authStateChanged",
        "Post notification with userInfo containing 'isAuthenticated' boolean when token is set or cleared",
        "Post notification from setAuthToken() and clearAuthToken() methods",
        "Post notification with isAuthenticated=false when 401 response received",
        "Typecheck passes (swift build)"
      ],
      "description": "As a developer, I need APIClient to publish auth state changes so the app can react to session expiry.",
      "id": "US-061",
      "notes": "",
      "passes": true,
      "priority": 61,
      "title": "Create AuthState publisher in APIClient"
    },
    {
      "acceptanceCriteria": [
        "Create SessionExpiredAlert view modifier in Utilities/SessionExpiredAlert.swift",
        "Show alert with title 'Session Expired' and message 'Please log in again'",
        "Alert has single 'OK' button that dismisses",
        "Alert triggers navigation to login (via callback)",
        "Typecheck passes (swift build)"
      ],
      "description": "As a customer, I need to see a message when my session expires so I understand why I'm being logged out.",
      "id": "US-062",
      "notes": "",
      "passes": true,
      "priority": 62,
      "title": "Add session expiry alert UI"
    },
    {
      "acceptanceCriteria": [
        "OFFLEASHApp observes Notification.Name.authStateChanged",
        "When isAuthenticated becomes false, set local isAuthenticated state to false",
        "Show SessionExpiredAlert before navigating to login",
        "Clear any in-progress booking state when session expires",
        "Typecheck passes (swift build)",
        "Verify in simulator: force 401 response, confirm alert shows and redirects to login"
      ],
      "description": "As a customer, when my session expires I should be automatically redirected to login.",
      "id": "US-063",
      "notes": "",
      "passes": true,
      "priority": 63,
      "title": "Implement session recovery in OFFLEASHApp"
    },
    {
      "acceptanceCriteria": [
        "Create TokenValidationResponse struct in Models/TokenValidation.swift",
        "Fields: valid (Bool), expiresAt (Date?)",
        "Struct conforms to Decodable",
        "Typecheck passes (swift build)"
      ],
      "description": "As a developer, I need models for the token validation endpoint response.",
      "id": "US-064",
      "notes": "",
      "passes": true,
      "priority": 64,
      "title": "Create token validation response model"
    },
    {
      "acceptanceCriteria": [
        "Add validateToken() async throws -> TokenValidationResponse method to APIClient",
        "Calls GET /auth/validate endpoint",
        "Returns TokenValidationResponse on success",
        "Throws APIError.unauthorized on 401",
        "Typecheck passes (swift build)"
      ],
      "description": "As a developer, I need an API method to validate the stored token.",
      "id": "US-065",
      "notes": "",
      "passes": true,
      "priority": 65,
      "title": "Add validateToken method to APIClient"
    },
    {
      "acceptanceCriteria": [
        "Add AppState enum: .launching, .validating, .authenticated, .unauthenticated",
        "On app launch, if token exists, set state to .validating and call validateToken()",
        "Show ProgressView with 'Verifying session...' during validation",
        "If valid: set state to .authenticated, show ContentView",
        "If invalid/401: clear token, set state to .unauthenticated, show LoginView",
        "If network error: set state to .authenticated (graceful degradation), show ContentView",
        "Typecheck passes (swift build)",
        "Verify in simulator: test with valid token, expired token, and airplane mode"
      ],
      "description": "As a customer, when I open the app with a stored token, it should verify the token is still valid.",
      "id": "US-066",
      "notes": "",
      "passes": true,
      "priority": 66,
      "title": "Implement token validation on app launch"
    },
    {
      "acceptanceCriteria": [
        "Create Services/CacheManager.swift as an actor",
        "Generic support for any Codable type",
        "Methods: get<T>(key:) -> T?, set<T>(key:value:ttl:), remove(key:), clear()",
        "Persist to FileManager.default.urls(for: .cachesDirectory)",
        "Store metadata (expiry timestamp) alongside cached data",
        "Return nil from get() if TTL expired",
        "Typecheck passes (swift build)"
      ],
      "description": "As a developer, I need a reusable caching layer that persists data to disk with TTL support.",
      "id": "US-067",
      "notes": "",
      "passes": true,
      "priority": 67,
      "title": "Create CacheManager actor"
    },
    {
      "acceptanceCriteria": [
        "Add maxCacheSize property (default 50MB) to CacheManager",
        "Track cache entry sizes and access times",
        "On set(), if total size exceeds limit, evict least recently used entries",
        "Add currentCacheSize() method for debugging",
        "Typecheck passes (swift build)"
      ],
      "description": "As a developer, I need the cache to enforce a size limit to prevent disk bloat.",
      "id": "US-068",
      "notes": "",
      "passes": true,
      "priority": 68,
      "title": "Add cache size limit with LRU eviction"
    },
    {
      "acceptanceCriteria": [
        "ServicesView checks CacheManager for 'services' key before network request",
        "If cache hit: show cached data immediately, then fetch fresh data in background",
        "If cache miss: show loading state, fetch from network, cache response with 5-minute TTL",
        "Update UI when background refresh completes (if data changed)",
        "Pull-to-refresh bypasses cache and forces network fetch",
        "Typecheck passes (swift build)",
        "Verify in simulator: load services, kill app, relaunch, confirm instant display"
      ],
      "description": "As a customer, I want to see the services list instantly on repeat visits.",
      "id": "US-069",
      "notes": "",
      "passes": true,
      "priority": 69,
      "title": "Cache services list with stale-while-revalidate"
    },
    {
      "acceptanceCriteria": [
        "LocationSelectionView checks CacheManager for 'locations' key before network request",
        "Same stale-while-revalidate pattern as services",
        "Cache TTL: 10 minutes",
        "Add CacheManager.invalidate(key:) method",
        "Invalidate 'locations' cache when customer adds/edits/deletes a location",
        "Typecheck passes (swift build)",
        "Verify in simulator: load locations, kill app, relaunch, confirm instant display"
      ],
      "description": "As a customer, I want to see my saved locations instantly.",
      "id": "US-070",
      "notes": "",
      "passes": true,
      "priority": 70,
      "title": "Cache locations list with invalidation"
    },
    {
      "acceptanceCriteria": [
        "Update ServicesView fetchServices() to call GET /services?active=true",
        "Add queryItems parameter support to APIClient.get() method",
        "Remove client-side .filter { $0.isActive } from ServicesView",
        "Typecheck passes (swift build)"
      ],
      "description": "As a developer, I want to filter inactive services on the server to reduce payload size.",
      "id": "US-071",
      "notes": "Assumes backend supports ?active=true query param",
      "passes": true,
      "priority": 71,
      "title": "Update services fetch to use server-side filtering"
    },
    {
      "acceptanceCriteria": [
        "Create Services/AnalyticsService.swift with AnalyticsService protocol",
        "Protocol methods: trackScreenView(screenName:), trackEvent(name:params:), trackError(error:context:)",
        "Create StubAnalyticsService that logs to console (for development)",
        "Inject via environment or singleton pattern",
        "Typecheck passes (swift build)"
      ],
      "description": "As a developer, I need an analytics abstraction for testability.",
      "id": "US-072",
      "notes": "",
      "passes": true,
      "priority": 72,
      "title": "Create AnalyticsService protocol and stub"
    },
    {
      "acceptanceCriteria": [
        "Add Firebase SDK dependency via Swift Package Manager",
        "Create FirebaseAnalyticsService implementing AnalyticsService protocol",
        "Configure Firebase in OFFLEASHApp.init() with FirebaseApp.configure()",
        "Create GoogleService-Info.plist placeholder with instructions",
        "Typecheck passes (swift build)"
      ],
      "description": "As a product manager, I need analytics infrastructure to measure customer behavior.",
      "id": "US-073",
      "notes": "",
      "passes": false,
      "priority": 73,
      "title": "Integrate Firebase Analytics SDK"
    },
    {
      "acceptanceCriteria": [
        "Add .onAppear { analyticsService.trackScreenView(screenName:) } to: LoginView, RegisterView, ServicesView, LocationSelectionView, BookingStartView",
        "Screen names: 'login', 'register', 'services', 'location_selection', 'booking_start'",
        "Typecheck passes (swift build)"
      ],
      "description": "As a product manager, I want to know which screens customers visit.",
      "id": "US-074",
      "notes": "",
      "passes": false,
      "priority": 74,
      "title": "Track screen view events"
    },
    {
      "acceptanceCriteria": [
        "Add startTime property to ServicesView and LocationSelectionView",
        "Record Date() in .onAppear",
        "When isLoading becomes false, calculate duration and call analyticsService.trackEvent('tti', params: ['screen': screenName, 'duration_ms': duration, 'cache_hit': wasCacheHit])",
        "Typecheck passes (swift build)"
      ],
      "description": "As an engineer, I want to measure how long customers wait for content to load.",
      "id": "US-075",
      "notes": "",
      "passes": false,
      "priority": 75,
      "title": "Track time-to-interactive metrics"
    },
    {
      "acceptanceCriteria": [
        "Update APIClient request() method to call analyticsService.trackError() on any error",
        "Include context: endpoint path, HTTP method, status code (if available), error type",
        "Redact any auth tokens from logged data",
        "Typecheck passes (swift build)"
      ],
      "description": "As an engineer, I want to know when and where customers encounter errors.",
      "id": "US-076",
      "notes": "",
      "passes": false,
      "priority": 76,
      "title": "Track API error events"
    },
    {
      "acceptanceCriteria": [
        "Track 'funnel_step' event with step parameter at each stage",
        "Steps: 'services_viewed', 'service_selected', 'location_selected', 'booking_started', 'booking_confirmed'",
        "Include service_id and location_id where applicable",
        "Typecheck passes (swift build)"
      ],
      "description": "As a product manager, I want to measure conversion through the booking funnel.",
      "id": "US-077",
      "notes": "",
      "passes": false,
      "priority": 77,
      "title": "Track booking funnel progression"
    },
    {
      "acceptanceCriteria": [
        "Add FirebaseCrashlytics dependency via Swift Package Manager",
        "Configure Crashlytics in OFFLEASHApp.init()",
        "Set user ID for authenticated users: Crashlytics.crashlytics().setUserID()",
        "Clear user ID on logout",
        "Typecheck passes (swift build)"
      ],
      "description": "As an engineer, I want to be notified of app crashes with stack traces.",
      "id": "US-078",
      "notes": "",
      "passes": false,
      "priority": 78,
      "title": "Integrate Firebase Crashlytics"
    },
    {
      "acceptanceCriteria": [
        "Create URLSessionDelegate in APIClient that implements urlSession(_:didReceive:completionHandler:)",
        "Extract server certificate from SecTrust",
        "Compare certificate public key hash against pinned hashes",
        "Store pinned hashes in array (primary + backup for rotation)",
        "Reject connection if no pin matches",
        "Add documentation comment explaining certificate rotation procedure",
        "Typecheck passes (swift build)"
      ],
      "description": "As a security engineer, I want to prevent MITM attacks on API communication.",
      "id": "US-079",
      "notes": "",
      "passes": false,
      "priority": 79,
      "title": "Implement certificate pinning"
    },
    {
      "acceptanceCriteria": [
        "Create Utilities/Validators.swift with isValidEmail(_:) function",
        "Use proper email regex (at minimum: contains @, has domain with dot)",
        "Add @State emailError: String? to LoginView and RegisterView",
        "Validate on field blur (onChange with debounce) and on submit",
        "Show red error text below email field when invalid",
        "Error message: 'Please enter a valid email address'",
        "Typecheck passes (swift build)",
        "Verify in simulator: test with invalid emails"
      ],
      "description": "As a customer, I want clear feedback if my email format is invalid.",
      "id": "US-080",
      "notes": "",
      "passes": false,
      "priority": 80,
      "title": "Strengthen email validation"
    },
    {
      "acceptanceCriteria": [
        "Create Components/PasswordRequirements.swift view",
        "Display requirements: min 8 chars, 1 uppercase, 1 number",
        "Show checkmark (SF Symbol: checkmark.circle.fill, green) for met requirements",
        "Show empty circle (SF Symbol: circle, gray) for unmet requirements",
        "Add PasswordRequirements view below password field in RegisterView",
        "Update isRegisterEnabled to check all requirements met",
        "Typecheck passes (swift build)",
        "Verify in simulator: requirements update in real-time"
      ],
      "description": "As a customer, I want to understand password requirements during registration.",
      "id": "US-081",
      "notes": "",
      "passes": false,
      "priority": 81,
      "title": "Add password strength requirements UI"
    }
  ]
}