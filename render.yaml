# =============================================================================
# OFFLEASH - Render Blueprint
# Documentation: https://render.com/docs/blueprint-spec
# =============================================================================
#
# DEPLOYMENT STRATEGY:
#   - API: Pre-built Docker image from GitHub Container Registry (GHCR)
#          Built by GitHub Actions, deployed via deploy hook
#   - Web Apps: Built on Render, deployed via GitHub Actions deploy hooks
#
# COST BREAKDOWN (Test Environment):
#   - API (Rust):        $7/mo (Starter) - always on
#   - PostgreSQL:        Free (30-day expiration, 1GB)
#   - Customer Web:      Free (auto-sleeps after 15min inactivity)
#   - Admin Dashboard:   Free (auto-sleeps)
#   - Platform Admin:    Free (auto-sleeps)
#   TOTAL: ~$7/mo
#
# For production, upgrade database to basic-256mb ($7/mo) or higher
# =============================================================================

# =============================================================================
# DATABASES
# =============================================================================
databases:
  - name: offleash-db
    plan: free
    databaseName: offleash
    user: offleash
    region: oregon
    postgresMajorVersion: "16"

# =============================================================================
# SERVICES
# =============================================================================
services:
  # ---------------------------------------------------------------------------
  # API Server (Rust) - Pre-built image from GitHub Container Registry
  # Image built by GitHub Actions (.github/workflows/build-api.yml)
  # Deployed via deploy hook triggered by GitHub Actions
  # ---------------------------------------------------------------------------
  - type: web
    name: offleash-api
    runtime: image
    plan: starter
    region: oregon
    image:
      url: ghcr.io/kcirtapfromspace/offleash-api:latest
      # If using private image, add credentials in Render Dashboard:
      # Account Settings → Registry Credentials → Add ghcr.io credential
    healthCheckPath: /health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: offleash-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: RUST_LOG
        value: info,tower_http=info,sqlx=warn
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 8080
      - key: ENVIRONMENT
        value: test
      - key: BASE_DOMAIN
        value: offleash.world
      - key: CORS_ORIGINS
        value: https://offleash.world,https://paperwork.offleash.world,https://platform.offleash.world,https://offleash-app.onrender.com,https://offleash-admin.onrender.com,https://offleash-platform.onrender.com
      # OAuth Configuration - Use same env vars as web apps for shared env group
      - key: PUBLIC_GOOGLE_CLIENT_ID
        sync: false  # Set via environment group
      - key: PUBLIC_APPLE_CLIENT_ID
        sync: false  # Set via environment group
      - key: APPLE_IOS_BUNDLE_ID
        sync: false  # Set via environment group (com.offleash.ios)
    # Auto-deploy disabled - GitHub Actions triggers deploy via hook
    autoDeploy: false

  # ---------------------------------------------------------------------------
  # Customer Web App (SvelteKit Node.js) - Free tier with auto-sleep
  # Deployed via deploy hook triggered by GitHub Actions
  # ---------------------------------------------------------------------------
  - type: web
    name: offleash-app
    runtime: node
    plan: free
    region: oregon
    rootDir: apps/customer-web
    buildCommand: npm ci --include=dev && npm run build
    startCommand: node build
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 3000
      - key: PUBLIC_API_URL
        value: https://api.offleash.world
      - key: PUBLIC_ADMIN_URL
        value: https://paperwork.offleash.world
      # IMPORTANT: Set ORIGIN to your actual domain in Render dashboard
      # Custom domain: https://offleash.world
      - key: ORIGIN
        value: https://offleash.world
      # OAuth Configuration - Set these in Render Dashboard
      - key: PUBLIC_GOOGLE_CLIENT_ID
        sync: false  # Set manually in dashboard
      - key: PUBLIC_APPLE_CLIENT_ID
        sync: false  # Set manually in dashboard
    # Auto-deploy disabled - GitHub Actions triggers deploy via hook
    autoDeploy: false

  # ---------------------------------------------------------------------------
  # Admin Dashboard (SvelteKit Node.js) - Free tier with auto-sleep
  # Deployed via deploy hook triggered by GitHub Actions
  # ---------------------------------------------------------------------------
  - type: web
    name: offleash-admin
    runtime: node
    plan: free
    region: oregon
    rootDir: apps/admin-dashboard
    buildCommand: npm ci --include=dev && npm run build
    startCommand: node build
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 3000
      - key: PUBLIC_API_URL
        value: https://api.offleash.world
      - key: PUBLIC_CUSTOMER_URL
        value: https://offleash.world
      - key: ORIGIN
        value: https://paperwork.offleash.world
      # OAuth Configuration - Set these in Render Dashboard
      - key: PUBLIC_GOOGLE_CLIENT_ID
        sync: false  # Set manually in dashboard
      - key: PUBLIC_APPLE_CLIENT_ID
        sync: false  # Set manually in dashboard
    # Auto-deploy disabled - GitHub Actions triggers deploy via hook
    autoDeploy: false

  # ---------------------------------------------------------------------------
  # Platform Admin (SvelteKit Node.js) - Free tier with auto-sleep
  # Deployed via deploy hook triggered by GitHub Actions
  # ---------------------------------------------------------------------------
  - type: web
    name: offleash-platform
    runtime: node
    plan: free
    region: oregon
    rootDir: apps/platform-admin
    buildCommand: npm ci --include=dev && npm run build
    startCommand: node build
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 3000
      - key: PUBLIC_API_URL
        value: https://api.offleash.world
      - key: ORIGIN
        value: https://platform.offleash.world
    # Auto-deploy disabled - GitHub Actions triggers deploy via hook
    autoDeploy: false
