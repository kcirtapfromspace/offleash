# =============================================================================
# OFFLEASH - Render Blueprint
# Documentation: https://render.com/docs/blueprint-spec
# =============================================================================
#
# COST BREAKDOWN (Test Environment):
#   - API (Rust):        $7/mo (Starter) - always on
#   - PostgreSQL:        Free (30-day expiration, 1GB)
#   - Customer Web:      Free (auto-sleeps after 15min inactivity)
#   - Admin Dashboard:   Free (auto-sleeps)
#   - Platform Admin:    Free (auto-sleeps)
#   TOTAL: ~$7/mo
#
# For production, upgrade database to basic-256mb ($7/mo) or higher
# =============================================================================

# =============================================================================
# DATABASES
# =============================================================================
databases:
  - name: offleash-db
    plan: free
    databaseName: offleash
    user: offleash
    region: oregon
    postgresMajorVersion: "16"

# =============================================================================
# SERVICES
# =============================================================================
services:
  # ---------------------------------------------------------------------------
  # API Server (Rust) - Starter plan for always-on
  # ---------------------------------------------------------------------------
  - type: web
    name: offleash-api
    runtime: docker
    plan: starter
    region: oregon
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: offleash-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: RUST_LOG
        value: info,tower_http=info,sqlx=warn
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 8080
      - key: ENVIRONMENT
        value: test
      - key: BASE_DOMAIN
        value: offleash.world
      - key: CORS_ORIGINS
        value: https://app.offleash.world,https://admin.offleash.world,https://platform.offleash.world,https://offleash-app.onrender.com,https://offleash-admin.onrender.com,https://offleash-platform.onrender.com
      # OAuth Configuration - Use same env vars as web apps for shared env group
      - key: PUBLIC_GOOGLE_CLIENT_ID
        sync: false  # Set via environment group
      - key: PUBLIC_APPLE_CLIENT_ID
        sync: false  # Set via environment group
    autoDeploy: true
    buildFilter:
      paths:
        - crates/**
        - migrations/**
        - Cargo.toml
        - Cargo.lock
        - Dockerfile

  # ---------------------------------------------------------------------------
  # Customer Web App (SvelteKit Node.js) - Free tier with auto-sleep
  # ---------------------------------------------------------------------------
  - type: web
    name: offleash-app
    runtime: node
    plan: free
    region: oregon
    rootDir: apps/customer-web
    buildCommand: npm ci --include=dev && npm run build
    startCommand: node build
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 3000
      - key: PUBLIC_API_URL
        value: https://offleash-api.onrender.com
      - key: ORIGIN
        value: https://offleash-app.onrender.com
      # OAuth Configuration - Set these in Render Dashboard
      - key: PUBLIC_GOOGLE_CLIENT_ID
        sync: false  # Set manually in dashboard
      - key: PUBLIC_APPLE_CLIENT_ID
        sync: false  # Set manually in dashboard
    autoDeploy: true
    buildFilter:
      paths:
        - "**"

  # ---------------------------------------------------------------------------
  # Admin Dashboard (SvelteKit Node.js) - Free tier with auto-sleep
  # ---------------------------------------------------------------------------
  - type: web
    name: offleash-admin
    runtime: node
    plan: free
    region: oregon
    rootDir: apps/admin-dashboard
    buildCommand: npm ci --include=dev && npm run build
    startCommand: node build
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 3000
      - key: PUBLIC_API_URL
        value: https://offleash-api.onrender.com
      - key: ORIGIN
        value: https://offleash-admin.onrender.com
      # OAuth Configuration - Set these in Render Dashboard
      - key: PUBLIC_GOOGLE_CLIENT_ID
        sync: false  # Set manually in dashboard
      - key: PUBLIC_APPLE_CLIENT_ID
        sync: false  # Set manually in dashboard
    autoDeploy: true
    buildFilter:
      paths:
        - "**"

  # ---------------------------------------------------------------------------
  # Platform Admin (SvelteKit Node.js) - Free tier with auto-sleep
  # ---------------------------------------------------------------------------
  - type: web
    name: offleash-platform
    runtime: node
    plan: free
    region: oregon
    rootDir: apps/platform-admin
    buildCommand: npm ci --include=dev && npm run build
    startCommand: node build
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: 3000
      - key: PUBLIC_API_URL
        value: https://offleash-api.onrender.com
      - key: ORIGIN
        value: https://offleash-platform.onrender.com
    autoDeploy: true
    buildFilter:
      paths:
        - "**"
